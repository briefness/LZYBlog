# 11. 智能应用：Flutter x AI (Gemini)

移动应用的下半场是 **AI Native**。
Flutter 凭借其快速的 UI 构建能力和跨平台特性，是落地 AI 应用的绝佳容器。Google 官方也推出了 `google_generative_ai` 包，让你在 Flutter 中能像调用普通 API 一样调用 Gemini 模型。

## 1. 接入 Gemini：从 Hello World 到多模态

以往需自行搭建 Python 后端转发，现可以直接在客户端安全地调用（借助 Firebase App Check 保护 Key）。

### 基础文本生成

```dart
// 1. 初始化模型
final model = GenerativeModel(
  model: 'gemini-pro',
  apiKey: apiKey,
);

// 2. 生成内容
final content = [Content.text('用 Flutter 写一首诗')];
final response = await model.generateContent(content);
print(response.text);
```

### 多模态 (Multimodal) 输入

Gemini 具备图像理解能力。在 Flutter 中，可直接把 `File` 读取为 bytes 传递给模型。

```dart
final image = await File('cat.jpg').readAsBytes();
final content = [
  Content.multi([
    TextPart('这是什么品种的猫？'),
    DataPart('image/jpeg', image),
  ])
];
```

## 2. 流式响应 (Streaming UI)

AI 的推理是耗时的。为避免用户等待，需实现 **Streaming (流式)** 响应，即“打字机效果”。

### StreamBuilder 的妙用

`model.generateContentStream` 返回的是一个 `Stream<GenerateContentResponse>`。
配合 `StreamBuilder`，可实时把 AI 吐出来的字追加到屏幕上，无需复杂的 Socket 编程。

```dart
StreamBuilder<GenerateContentResponse>(
  stream: model.generateContentStream(prompt),
  builder: (context, snapshot) {
    if (snapshot.hasData) {
      // 累加显示当前生成的文本
      return MarkdownBody(data: displayedText + snapshot.data!.text); 
    }
    return CircularProgressIndicator();
  },
)
```

## 3. 进阶：Agentic UI (代理式界面)

AI 不仅仅能生成文字，还能**控制 UI**。
这被称为 **Generative UI** 或 **Agentic flow**。

### Function Calling (工具调用)

可告知 Gemini：“拥有如下工具（API）：打开灯、播放音乐、导航到某地”。
当用户指令触发时，Gemini 将返回结构化的 **Function Call** 指令，而非普通文本。

```json
// AI 的响应
{
  "functionCall": {
    "name": "turnOnLight",
    "args": { "room": "living_room" }
  }
}
```

Flutter 端代码解析该指令，调用真实硬件接口并反馈结果，完成 Agent 闭环。

## 4. 企业级方案：Vertex AI

对于需要更高并发、数据合规或微调模型（Fine-tuning）的商业应用，不能直接用面向开发者的 API Key。
需要接入 **Google Cloud Vertex AI**。

*   **Firebase Extensions**: 使用 "Chatbot with Gemini" 扩展，无需写后端代码即可将 Firestore 连接到 Vertex AI。
*   **后端中转**: 最佳实践架构：Flutter -> Go/Node 后端 -> Vertex AI。以此隐藏 Prompt 逻辑，保护 API 凭证，并进行复杂的 RAG (检索增强生成) 逻辑。

## 5. On-Device AI (端侧模型)

对于隐私敏感或无网环境，可使用 **TensorFlow Lite** 或 **MediaPipe** 在设备本地运行小模型。
Flutter 提供了 `tflite_flutter` 插件，虽然精度不如云端大模型，但胜在实时性（如实时手势识别、背景分割）。

## 总结

Flutter + AI 的组合，使开发者不仅专注于 UI，更能创造智能体验。
从简单的 API 调用，到复杂的 Agent 交互，Flutter 的声明式 UI 完美契合了 AI 的不确定性输出。

> **官方资源**: [Build with AI on Flutter](https://flutter.dev/ai)

