import{_ as i,o as a,c as t,ag as e}from"./chunks/framework.CbQjVMS6.js";const E=JSON.parse('{"title":"é¸¿è’™å¼€å‘è¿›é˜¶ï¼ˆä¹ï¼‰ï¼šæœ¬åœ°æ•°æ®åº“ (RDB) æ·±åº¦è§£æ","description":"","frontmatter":{},"headers":[],"relativePath":"posts/harmonyos/Articles/Persistence.md","filePath":"posts/harmonyos/Articles/Persistence.md"}'),n={name:"posts/harmonyos/Articles/Persistence.md"};function l(h,s,p,r,k,o){return a(),t("div",null,[...s[0]||(s[0]=[e(`<h1 id="é¸¿è’™å¼€å‘è¿›é˜¶-ä¹-æœ¬åœ°æ•°æ®åº“-rdb-æ·±åº¦è§£æ" tabindex="-1">é¸¿è’™å¼€å‘è¿›é˜¶ï¼ˆä¹ï¼‰ï¼šæœ¬åœ°æ•°æ®åº“ (RDB) æ·±åº¦è§£æ <a class="header-anchor" href="#é¸¿è’™å¼€å‘è¿›é˜¶-ä¹-æœ¬åœ°æ•°æ®åº“-rdb-æ·±åº¦è§£æ" aria-label="Permalink to &quot;é¸¿è’™å¼€å‘è¿›é˜¶ï¼ˆä¹ï¼‰ï¼šæœ¬åœ°æ•°æ®åº“ (RDB) æ·±åº¦è§£æ&quot;">â€‹</a></h1><blockquote><p>ğŸ”— <strong>é¡¹ç›®åœ°å€</strong>ï¼š<a href="https://github.com/briefness/HarmonyDemo" target="_blank" rel="noreferrer">https://github.com/briefness/HarmonyDemo</a></p></blockquote><blockquote><p><strong>æ›´æ–°è¯´æ˜</strong>ï¼šæœ¬æ–‡å°†ä»‹ç» RDB çš„ APIï¼Œä»¥åŠ SQLite åº•å±‚çš„ <strong>B-Tree ç´¢å¼•</strong> å’Œ <strong>WAL</strong> æœºåˆ¶ã€‚</p></blockquote><h2 id="ä¸€ã€ç†è®ºåŸºç¡€-æ•°æ®åº“ä¸ºä»€ä¹ˆå¿«" tabindex="-1">ä¸€ã€ç†è®ºåŸºç¡€ï¼šæ•°æ®åº“ä¸ºä»€ä¹ˆå¿«ï¼Ÿ <a class="header-anchor" href="#ä¸€ã€ç†è®ºåŸºç¡€-æ•°æ®åº“ä¸ºä»€ä¹ˆå¿«" aria-label="Permalink to &quot;ä¸€ã€ç†è®ºåŸºç¡€ï¼šæ•°æ®åº“ä¸ºä»€ä¹ˆå¿«ï¼Ÿ&quot;">â€‹</a></h2><h3 id="_1-1-b-tree-ç´¢å¼•" tabindex="-1">1.1 B-Tree ç´¢å¼• <a class="header-anchor" href="#_1-1-b-tree-ç´¢å¼•" aria-label="Permalink to &quot;1.1 B-Tree ç´¢å¼•&quot;">â€‹</a></h3><p>ä¸ºä»€ä¹ˆåœ¨ç™¾ä¸‡æ¡æ•°æ®ä¸­æŸ¥è¯¢ ID åªéœ€è¦å‡ æ¯«ç§’ï¼Ÿ å› ä¸º RDB (åŸºäº SQLite) ä½¿ç”¨ <strong>B-Tree</strong> ç»“æ„å­˜å‚¨ç´¢å¼•ã€‚</p><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Root((æ ¹èŠ‚ç‚¹)) --&gt;|key &lt; 50| Left((å­èŠ‚ç‚¹ A))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Root --&gt;|key &gt;= 50| Right((å­èŠ‚ç‚¹ B))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Left --&gt;|1-25| L1[æ•°æ®å— 1]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Left --&gt;|26-49| L2[æ•°æ®å— 2]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Right --&gt;|50-75| R1[æ•°æ®å— 3]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Right --&gt;|76-100| R2[æ•°æ®å— 4]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    style Root fill:#f9f,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    style Left fill:#bbf,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    style Right fill:#bbf,stroke:#333</span></span></code></pre></div><ul><li>å®ƒæ˜¯ä¸€ç§å¹³è¡¡æ ‘ç»“æ„ã€‚</li><li>æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ä¸º <strong>O(log N)</strong>ã€‚</li><li><strong>æœ€ä½³å®è·µ</strong>: ç»å¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µï¼ˆå¦‚ <code>userId</code>, <code>createTime</code>ï¼‰ï¼Œå»ºè®®åˆ›å»º Indexã€‚</li></ul><h3 id="_1-2-wal-write-ahead-logging" tabindex="-1">1.2 WAL (Write-Ahead Logging) <a class="header-anchor" href="#_1-2-wal-write-ahead-logging" aria-label="Permalink to &quot;1.2 WAL (Write-Ahead Logging)&quot;">â€‹</a></h3><p>SQLite é»˜è®¤å¼€å¯ WAL æ¨¡å¼ã€‚</p><ul><li><strong>åŸç†</strong>: ä¿®æ”¹æ•°æ®æ—¶ï¼Œä¸ç›´æ¥æ”¹åŸæ–‡ä»¶ <code>db</code>ï¼Œè€Œæ˜¯å…ˆè¿½åŠ å†™å…¥æ—¥å¿—æ–‡ä»¶ <code>db-wal</code>ã€‚</li><li><strong>ä¼˜åŠ¿</strong>: è¯»å†™å®Œå…¨å¹¶å‘ã€‚å†™æ“ä½œä¸ä¼šé˜»å¡è¯»æ“ä½œ (No Locking)ã€‚</li><li>è¿™ä¿è¯äº†åå°æ•°æ®åŒæ­¥æ—¶ä¸é˜»å¡ UI è¯»å–ã€‚</li></ul><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant UI as UI çº¿ç¨‹ (è¯»)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant BG as åå°çº¿ç¨‹ (å†™)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant DB as åŸå§‹ DB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant WAL as WAL æ–‡ä»¶</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    BG-&gt;&gt;WAL: 1. è¿½åŠ æ–°é¡µ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note right of BG: å†™å…¥å¿« (é¡ºåº IO)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UI-&gt;&gt;DB: 2. è¯»å–æ—§é¡µ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note left of UI: è¯»å–ä¸è¢«é˜»å¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    WAL--&gt;&gt;DB: 3. æ£€æŸ¥ç‚¹å›å†™ (ç©ºé—²æ—¶)</span></span></code></pre></div><h2 id="äºŒã€æ ¸å¿ƒæ¦‚å¿µ-è°“è¯-predicates" tabindex="-1">äºŒã€æ ¸å¿ƒæ¦‚å¿µï¼šè°“è¯ (Predicates) <a class="header-anchor" href="#äºŒã€æ ¸å¿ƒæ¦‚å¿µ-è°“è¯-predicates" aria-label="Permalink to &quot;äºŒã€æ ¸å¿ƒæ¦‚å¿µï¼šè°“è¯ (Predicates)&quot;">â€‹</a></h2><p><code>RdbPredicates</code> æ˜¯ SQL <code>WHERE</code> å­å¥çš„å°è£…ã€‚</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SELECT * FROM TASK WHERE ID = 5 AND DONE = 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> predicates </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> relationalStore.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RdbPredicates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;TASK&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">predicates.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">equalTo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ID&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">equalTo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;DONE&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h2 id="ä¸‰ã€æ ¸å¿ƒ-api-æµç¨‹" tabindex="-1">ä¸‰ã€æ ¸å¿ƒ API æµç¨‹ <a class="header-anchor" href="#ä¸‰ã€æ ¸å¿ƒ-api-æµç¨‹" aria-label="Permalink to &quot;ä¸‰ã€æ ¸å¿ƒ API æµç¨‹&quot;">â€‹</a></h2><h3 id="_3-1-åˆå§‹åŒ–-init" tabindex="-1">3.1 åˆå§‹åŒ– (init) <a class="header-anchor" href="#_3-1-åˆå§‹åŒ–-init" aria-label="Permalink to &quot;3.1 åˆå§‹åŒ– (init)&quot;">â€‹</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> relationalStore.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRdbStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;TaskStore.db&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  securityLevel: relationalStore.SecurityLevel.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">S1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // æ•°æ®å®‰å…¨ç­‰çº§ï¼ŒS1-S4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h3 id="_3-2-æ¸¸æ ‡-resultset" tabindex="-1">3.2 æ¸¸æ ‡ (ResultSet) <a class="header-anchor" href="#_3-2-æ¸¸æ ‡-resultset" aria-label="Permalink to &quot;3.2 æ¸¸æ ‡ (ResultSet)&quot;">â€‹</a></h3><p>æŸ¥è¯¢è¿”å›çš„ <code>ResultSet</code> æ˜¯ä¸€ä¸ªæ¸¸æ ‡ï¼ŒæŒ‡å‘æ•°æ®è¡Œçš„<strong>å‰ä¸€è¡Œ</strong>ã€‚</p><ul><li><strong>æ³¨æ„</strong>: ResultSet æŒæœ‰èµ„æºï¼Œä½¿ç”¨å®Œæ¯•å¿…é¡» <code>close()</code>ï¼Œä»¥å…è€—å°½è¿æ¥æ± ã€‚</li></ul><h2 id="å››ã€å¸¸è§é—®é¢˜" tabindex="-1">å››ã€å¸¸è§é—®é¢˜ <a class="header-anchor" href="#å››ã€å¸¸è§é—®é¢˜" aria-label="Permalink to &quot;å››ã€å¸¸è§é—®é¢˜&quot;">â€‹</a></h2><ol><li><strong>å¼‚æ­¥</strong>: RDB çš„ I/O æ˜¯å¼‚æ­¥çš„ï¼Œå¿…é¡» <code>await</code>ã€‚</li><li><strong>Boolean æ˜ å°„</strong>: SQLite ä¸æ”¯æŒ Booleanï¼Œé€šå¸¸ä½¿ç”¨ Integer (0/1)ã€‚</li><li><strong>ä¸»é”®è‡ªå¢</strong>: æ¨è <code>ID INTEGER PRIMARY KEY AUTOINCREMENT</code>ã€‚</li></ol><h2 id="äº”ã€æ€»ç»“" tabindex="-1">äº”ã€æ€»ç»“ <a class="header-anchor" href="#äº”ã€æ€»ç»“" aria-label="Permalink to &quot;äº”ã€æ€»ç»“&quot;">â€‹</a></h2><p>æŒæ¡ RDB æ˜¯å¤„ç†å¤æ‚ä¸šåŠ¡æ•°æ®çš„åŸºç¡€ã€‚</p><ul><li>ç†è§£ <strong>B-Tree</strong>ï¼ŒçŸ¥é“ä½•æ—¶å»ºç´¢å¼•ã€‚</li><li>ç†è§£ <strong>WAL</strong>ï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆè¯»å†™äº’ä¸å¹²æ‰°ã€‚</li></ul><p>ä¸‹ä¸€ç¯‡ï¼Œå°†æ¢è®¨ <strong>çŠ¶æ€ç®¡ç† (State Management)</strong> V2 ç‰ˆæœ¬çš„ <strong>Proxy æœºåˆ¶</strong>ã€‚</p>`,27)])])}const g=i(n,[["render",l]]);export{E as __pageData,g as default};
